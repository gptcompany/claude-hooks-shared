---
phase: 04-coordination-claims
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [hooks/coordination/task_claim.py, hooks/coordination/task_release.py]
autonomous: true
---

<objective>
Implement task-level coordination hooks for Task tool (subagent spawning).

Purpose: Track which tasks are being worked on by which agents. Claim on PreToolUse(Task), release on SubagentStop.

Output: `hooks/coordination/task_claim.py` (PreToolUse) and `hooks/coordination/task_release.py` (SubagentStop)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/4-coordination-claims/4-RESEARCH.md
@.planning/phases/4-coordination-claims/4-CONTEXT.md

# Existing patterns to follow:
@/media/sam/1TB/claude-hooks-shared/hooks/core/mcp_client.py
@/media/sam/1TB/claude-hooks-shared/hooks/intelligence/trajectory_tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement task_claim.py (PreToolUse Task hook)</name>
  <files>hooks/coordination/task_claim.py</files>
  <action>
Create PreToolUse hook for Task tool.

Logic:
1. Extract task description from hook_input["tool_input"]["description"] or ["prompt"]
2. Generate unique task_id (use description hash + timestamp for uniqueness)
3. Generate or load session_id
4. Call claude-flow claims_claim:
   - issueId: "task:{task_id}"
   - claimant: "agent:{session_id}:task"
   - context: task description (truncated to 200 chars)
5. Task claims are informational (don't block) - for visibility only
6. Store task_id in session state for later release
7. Return {} (allow task to proceed)

Unlike file claims, task claims don't block - they provide visibility into what's running.
Log to coordination.log
  </action>
  <verify>python3 hooks/coordination/task_claim.py --help shows usage</verify>
  <done>task_claim.py created, claims task on PreToolUse(Task)</done>
</task>

<task type="auto">
  <name>Task 2: Implement task_release.py (SubagentStop hook)</name>
  <files>hooks/coordination/task_release.py</files>
  <action>
Create SubagentStop hook to release task claims when subagent completes.

Logic:
1. Extract agent_id from hook_input if available
2. Load session state to find active task claims for this agent
3. For each active task claim:
   - Call claude-flow claims_release
   - Call claude-flow claims_status to mark completed if successful
4. Broadcast completion via hooks_notify:
   - message: "Task completed: {task_description}"
   - target: "all"
   - data: {"task": task_id, "event": "completed"}
5. Clear task claims from session state
6. Return {}

Handle case where subagent had no claims (graceful noop).
Log to coordination.log
  </action>
  <verify>python3 hooks/coordination/task_release.py --help shows usage</verify>
  <done>task_release.py created, releases task claims on SubagentStop</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] hooks/coordination/task_claim.py is executable
- [ ] hooks/coordination/task_release.py is executable
- [ ] Both hooks accept JSON from stdin without error
- [ ] Both hooks return valid JSON to stdout
- [ ] Task claim creates entry visible in claims_board
</verification>

<success_criteria>
- All tasks completed
- Task claims provide visibility (don't block)
- SubagentStop releases claims properly
- Completion is broadcast to other agents
</success_criteria>

<output>
After completion, create `.planning/phases/4-coordination-claims/04-02-SUMMARY.md`
</output>
