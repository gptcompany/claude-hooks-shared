# Plan 02-01: Register Trajectory Tracking Hooks

**Phase:** 02-trajectory-learning
**Created:** 2026-01-20
**Scope:** Small (1-2 tasks)

## Objective

Register the existing `trajectory_tracker.py` hook in settings.json for PreToolUse(Task), PostToolUse(Task), and Stop events. Verify trajectory tracking works by spawning a Task agent.

## Prerequisites

- [x] trajectory_tracker.py exists at `/media/sam/1TB/claude-hooks-shared/hooks/intelligence/trajectory_tracker.py`
- [x] mcp_client.py provides memory_store/retrieve functions
- [x] claude-flow MCP intelligence tools verified working
- [x] Phase 1 (Session Recovery) verified complete

## Tasks

### Task 1: Register trajectory_tracker.py in settings.json

**Action:** Add hook entries for trajectory tracking to `~/.claude/settings.json`

**Hook registrations needed:**
```json
{
  "PreToolUse": [
    {
      "matcher": "Task",
      "hooks": [
        {
          "type": "command",
          "command": "/media/sam/1TB/claude-hooks-shared/hooks/intelligence/trajectory_tracker.py --event=start",
          "timeout": 5
        }
      ]
    }
  ],
  "PostToolUse": [
    {
      "matcher": "Task",
      "hooks": [
        {
          "type": "command",
          "command": "/media/sam/1TB/claude-hooks-shared/hooks/intelligence/trajectory_tracker.py --event=step",
          "timeout": 5
        }
      ]
    }
  ],
  "Stop": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "/media/sam/1TB/claude-hooks-shared/hooks/intelligence/trajectory_tracker.py --event=end",
          "timeout": 10
        }
      ]
    }
  ]
}
```

**Merge strategy:** Add to existing hook arrays, don't replace

### Task 2: Verify trajectory tracking works

**Action:** Spawn a simple Task agent and verify trajectory was recorded

**Verification steps:**
1. Spawn a Task agent (any simple task)
2. Check `/tmp/claude-metrics/trajectory_tracker.log` for entries
3. Check `~/.claude-flow/memory/store.json` for trajectory entries
4. Verify trajectory has: id, project, task, steps, status

## Success Criteria

- [ ] trajectory_tracker.py registered in settings.json for PreToolUse(Task)
- [ ] trajectory_tracker.py registered in settings.json for PostToolUse(Task)
- [ ] trajectory_tracker.py registered in settings.json for Stop
- [ ] Task agent spawn creates trajectory entry in MCP store
- [ ] Trajectory has steps recorded after Task completion
- [ ] Trajectory marked as completed on Stop

## Verification

```bash
# Check hook registration
python3 -c "import json; s=json.load(open('$HOME/.claude/settings.json')); print('PreToolUse Task:', 'trajectory_tracker' in str(s.get('hooks',{}).get('PreToolUse',[]))); print('PostToolUse Task:', 'trajectory_tracker' in str(s.get('hooks',{}).get('PostToolUse',[]))); print('Stop:', 'trajectory_tracker' in str(s.get('hooks',{}).get('Stop',[])))"

# Check trajectory log
tail -20 /tmp/claude-metrics/trajectory_tracker.log

# Check MCP store for trajectories
python3 -c "import json; s=json.load(open('$HOME/.claude-flow/memory/store.json')); trajectories=[k for k in s.get('entries',{}).keys() if 'trajectory:' in k]; print(f'Trajectories found: {len(trajectories)}'); [print(f'  - {k}') for k in trajectories[:5]]"
```

## Output

- Updated `~/.claude/settings.json` with trajectory hooks
- Verified trajectory entries in MCP store
- Ready for Phase 3 (Lesson Learning)

---

*Plan: 02-01*
*Phase: 02-trajectory-learning*
