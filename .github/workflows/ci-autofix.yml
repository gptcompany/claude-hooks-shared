name: CI Auto-Fix

# Trigger when CI workflow fails
on:
  workflow_run:
    workflows: ["CI", "Tests", "Build"]
    types: [completed]

jobs:
  autofix:
    name: Auto-Fix Failed CI
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Failed Run Info
        id: run_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get failed job logs
          RUN_ID="${{ github.event.workflow_run.id }}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Get workflow run details
          gh api repos/${{ github.repository }}/actions/runs/$RUN_ID > run_details.json
          echo "head_sha=$(jq -r '.head_sha' run_details.json)" >> $GITHUB_OUTPUT
          echo "head_branch=$(jq -r '.head_branch' run_details.json)" >> $GITHUB_OUTPUT

          # Get failed jobs
          gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs > jobs.json
          FAILED_JOB=$(jq -r '.jobs[] | select(.conclusion == "failure") | .id' jobs.json | head -1)
          echo "failed_job_id=$FAILED_JOB" >> $GITHUB_OUTPUT

      - name: Download Logs
        if: steps.run_info.outputs.failed_job_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/actions/jobs/${{ steps.run_info.outputs.failed_job_id }}/logs > job_logs.txt 2>/dev/null || echo "Could not download logs"

      - name: Extract Error Context
        id: error_context
        run: |
          if [ -f job_logs.txt ]; then
            # Extract error message
            ERROR_MSG=$(grep -E "(Error|FAILED|AssertionError)" job_logs.txt | head -5 || echo "Unknown error")
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Extract file path if present
            FILE_PATH=$(grep -oE "[a-zA-Z0-9_/]+\.py:[0-9]+" job_logs.txt | head -1 || echo "")
            echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Trigger ClaudeFlow Auto-Fix
        if: env.CLAUDEFLOW_WEBHOOK != ''
        env:
          CLAUDEFLOW_WEBHOOK: ${{ secrets.CLAUDEFLOW_WEBHOOK }}
        run: |
          curl -X POST "$CLAUDEFLOW_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "run_id": "${{ steps.run_info.outputs.run_id }}",
              "repository": "${{ github.repository }}",
              "branch": "${{ steps.run_info.outputs.head_branch }}",
              "sha": "${{ steps.run_info.outputs.head_sha }}",
              "error_message": "${{ steps.error_context.outputs.error_message }}",
              "file_path": "${{ steps.error_context.outputs.file_path }}"
            }' || echo "ClaudeFlow webhook not configured"

      - name: Create Issue for Manual Review
        if: env.CLAUDEFLOW_WEBHOOK == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "CI Failure: ${{ steps.run_info.outputs.head_branch }}" \
            --body "## CI Failure Detected

          **Workflow Run:** [${{ github.event.workflow_run.name }}](${{ github.event.workflow_run.html_url }})
          **Branch:** ${{ steps.run_info.outputs.head_branch }}
          **Commit:** ${{ steps.run_info.outputs.head_sha }}

          ### Error
          \`\`\`
          ${{ steps.error_context.outputs.error_message }}
          \`\`\`

          ### File
          ${{ steps.error_context.outputs.file_path }}

          ---
          *Auto-generated by CI Auto-Fix workflow*" \
            --label "ci-failure,auto-fix" || echo "Could not create issue"

      - name: Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "ðŸ”´ **CI Failure** in `${{ github.repository }}`\n\n**Branch:** `${{ steps.run_info.outputs.head_branch }}`\n**Error:** ${{ steps.error_context.outputs.error_message }}\n\n[View Run](${{ github.event.workflow_run.html_url }})"
            }' || echo "Discord webhook failed"
