# Reusable Security Scan Workflow
# Call from any repo: uses: gptcompany/claude-hooks-shared/.github/workflows/_reusable-security.yml@main

name: Security Scan

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      bandit-paths:
        description: 'Paths to scan with bandit'
        required: false
        type: string
        default: 'src/'
      fail-on-high-severity:
        description: 'Fail on HIGH severity issues'
        required: false
        type: boolean
        default: true
    outputs:
      vulnerabilities:
        description: 'Number of vulnerabilities found'
        value: ${{ jobs.security.outputs.vulnerabilities }}
      secrets_found:
        description: 'Number of secrets found'
        value: ${{ jobs.security.outputs.secrets_found }}

jobs:
  security:
    name: "Security Scan"
    runs-on: [self-hosted, shared]
    timeout-minutes: 10

    outputs:
      vulnerabilities: ${{ steps.bandit.outputs.vulnerabilities }}
      secrets_found: ${{ steps.gitleaks.outputs.secrets_found }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install security tools
        run: |
          pip install bandit
          if ! command -v gitleaks &> /dev/null; then
            curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz -C /tmp
            sudo mv /tmp/gitleaks /usr/local/bin/ || mv /tmp/gitleaks ~/.local/bin/
          fi

      - name: Run Bandit SAST
        id: bandit
        run: |
          set +e
          bandit -r ${{ inputs.bandit-paths }} -ll -ii -f json -o bandit_results.json 2>/dev/null
          set -e

          if [ -f bandit_results.json ]; then
            VULNS=$(jq '.results | length' bandit_results.json)
            HIGH_SEVERITY=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit_results.json)

            echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT

            if [ "$HIGH_SEVERITY" -gt 0 ] && [ "${{ inputs.fail-on-high-severity }}" = "true" ]; then
              echo "::error::Found $HIGH_SEVERITY HIGH severity security issues"
              jq '.results[] | select(.issue_severity == "HIGH") | "\(.filename):\(.line_number) - \(.issue_text)"' bandit_results.json
              exit 1
            elif [ "$VULNS" -gt 0 ]; then
              echo "::warning::Found $VULNS low/medium security issues"
            else
              echo "Bandit: No security issues found"
            fi
          else
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Gitleaks secrets scan
        id: gitleaks
        run: |
          set +e
          gitleaks detect --source . --report-format json --report-path gitleaks_results.json 2>/dev/null
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -eq 1 ]; then
            SECRETS=$(jq 'length' gitleaks_results.json 2>/dev/null || echo 0)
            echo "secrets_found=$SECRETS" >> $GITHUB_OUTPUT
            echo "::error::Found $SECRETS potential secrets in repository"
            jq '.[] | "\(.File):\(.StartLine) - \(.Description)"' gitleaks_results.json | head -10
            exit 1
          else
            echo "secrets_found=0" >> $GITHUB_OUTPUT
            echo "Gitleaks: No secrets found"
          fi

      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: |
            bandit_results.json
            gitleaks_results.json
          retention-days: 30
